# PROJECT_ANALYSIS.md

## Краткое описание архитектуры

Проект состоит из набора .NET приложений, собранных в одно решение. Основная идея: есть "ядро"
для моделей/представлений и несколько UI/сервисных приложений, которые общаются с внешним миром
через последовательные порты/UDP и обмен NMEA/PGN сообщениями. Исторически основной UI написан
на WinForms (папка `SourceCode/GPS`), параллельно существует WPF-ветка (`AgOpenGPS.WpfApp`,
`AgOpenGPS.WpfViews`) с тем же доменом, подключенная к `AgOpenGPS.Core`.

### Основные исполняемые проекты

- `AgOpenGPS` (WinForms): основное приложение навигации/управления. Тесно связано с OpenTK
  (OpenGL рендеринг), большим набором форм и классами в `SourceCode/GPS/Classes`.
- `AgIO` (WinForms): коммуникационный хаб (NMEA/UDP/serial/NTRIP). Может запускаться отдельно
  или вместе с AgOpenGPS.
- `GPS_Out` (WinForms): генератор/ретранслятор NMEA/PGN сообщений.
- `ModSim` (WinForms): симулятор модулей/связи для отладки.
- `AgDiag` (WinForms): диагностические инструменты/мониторинг.
- `AgOpenGPS.WpfApp` + `AgOpenGPS.WpfViews`: WPF-интерфейс, использующий `AgOpenGPS.Core`.

### Общие библиотеки и ядро

- `AgLibrary`: общие утилиты (настройки, логирование, UI-контролы).
- `AgOpenGPS.Core`: доменная модель, view model'ы, streamers (чтение/запись данных полей),
  presenters. Явно ориентировано на MVVM-подход.
- `AgOpenGPS.Core.Tests` / `AgLibrary.Tests`: ограниченный набор unit-тестов для части логики.

## Ключевые модули (папки/подсистемы)

- `SourceCode/GPS/Classes`: основная бизнес-логика для WinForms-версии. Здесь классы
  для навигации, управления, треков, полей, границ, секций, симуляции, звуков и пр.
- `SourceCode/GPS/IO`: сохранение/загрузка файлов (границы, траектории, контуры, участки).
- `SourceCode/GPS/Forms`: крупные формы с UI-логикой, в том числе `FormGPS` как главный экран.
- `SourceCode/AgOpenGPS.Core`: модели и view model'ы, через которые WPF и часть новых участков
  WinForms получают доступ к доменной логике.
- `SourceCode/AgIO/Source`: коммуникации, настройки портов, NTRIP, UDP и т.п.
- `SourceCode/GPS_Out/Source`: PGN/NMEA формирование и вывод в отдельном приложении.
- `SourceCode/ModSim/Source`: симулятор модулей и обмена данными.

## Потоки данных (высокоуровнево)

1. **Внешние устройства** -> `AgIO` (NMEA/UDP/Serial/NTRIP) -> `AgOpenGPS`.
2. **AgOpenGPS** -> вычисление навигации/трека/секции -> UI и запись файлов.
3. **AgOpenGPS** <-> **GPS_Out/ModSim/AgDiag** через UDP/Serial (в зависимости от режима).

## Проблемы и зоны риска

1. **Параллельные UI-стеки (WinForms + WPF)**  
   Существуют `AgOpenGPS` (WinForms) и `AgOpenGPS.WpfApp` (WPF), при этом оба используют
   разные слои UI. Это повышает риск расхождения функциональности и усложняет поддержку.

2. **Смешение старого и нового слоя доменной логики**  
   В `FormGPS` используются `AgOpenGPS.Core` модели/VM, но рядом остаются устаревшие
   свойства-обертки с пометкой `Deprecated` (см. `SourceCode/GPS/Forms/FormGPS.cs`).
   Это признак частичного рефакторинга и потенциальных дублей состояния.

3. **Крупные формы с большой ответственностью**  
   `FormGPS` и другие WinForms-формы агрегируют UI, состояние и часть бизнес-логики,
   что затрудняет тестирование и локальные изменения без побочных эффектов.

4. **Сильная связность приложений через протоколы/настройки**  
   Отдельные exe (`AgIO`, `GPS_Out`, `ModSim`, `AgOpenGPS`) обмениваются данными через
   протоколы/порты. Без явного контрактного слоя или версионирования возможен
   незаметный дрейф протоколов между версиями.

5. **Ограниченное покрытие тестами**  
   Есть тесты для `AgOpenGPS.Core` и `AgLibrary`, но основной WinForms-слой и
   коммуникационные сценарии практически не покрыты.

